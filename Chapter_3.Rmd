---
title: "tidy Baseball Chapter 3"
author: "C. A. Hamm"
date: "`r format(Sys.Date())`"
output:  
      html_document:  
        keep_md: true  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Chapter 3

```{r preliminaries}
library("Lahman")
library("dplyr"); options(dplyr.width = Inf)
library("ggplot2")
library("devtools")
library("readr")

set.seed(8761825)
session_info()
```

```{r Ch3.S1}
# Section 3.1
hof <- read_csv("https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/hofbatting.csv", col_names = TRUE)
head(hof)
dim(hof)
```

```{r Chapter_3.Section_2}
# Rather than multiple additions to the data, lets create all of the variables we are interested in all at once. 
hof <- hof %>% mutate(MidCareer = ((From + To) / 2), Era = cut(MidCareer, breaks = c(1800, 1900, 1919, 1941, 1960, 1976, 1993, 2050), labels=c("19th Century", "Lively Ball", "Dead Ball", "Integration", "Expansion", "Free Agency", "Long Ball")), HR.Rate = (HR / AB)) %>% rename(Name = X2)
head(hof)
# Let's get rid of the " HOF" in the name column
hof[, 2] <- gsub(" HOF", "", hof$Name)
head(hof)
```

```{r Figure_3.1}
# Using ggplot we don't need to create a table
## Figure 3.1
ggplot(hof, aes(x = Era)) + theme_bw() + geom_bar() + ylab("Frequency") + xlab("Era") + ggtitle("Era of the Nonpitching Hall of Famers")
```

### Skipping Figure 3.2

```{r Figure_3.3}
## Figure 3.3, a Clevelnd dot plot of HoFers by Era. I am having trouble with this. This may be the first time I haven't been able to get ggplot to do what I want.
T.era <- table(hof$Era)
T.era

dotchart(as.numeric(T.era), labels = names(T.era), xlab = "Frequency", ylab = "", pt.cex = 2, pch = 19) # note that there is a discrepency int the code on page 64 (naming the object "T.Era"), in previous example it is called "T.era."
# ggplot(hof, aes(y = Era, x = )) + geom_point(size = 2) # can't get ggplot to count the frequency of occurance. It can do that with a bar chart but not with geom_points(), to the best of my knowledge.
```

```{r Figure_3.4}
## Figure 3.4 - No need to subset priot to plotting, we can do it inline with the plot call. 
ggplot(hof %>% filter(HR >= 500), aes(y = reorder(Name, OPS), x = OPS)) + geom_point(size = 3) + theme_bw() + theme(panel.grid.major.x = element_blank(), panel.grid.minor.y = element_blank(), panel.grid.major.y = element_line(color = "grey60", linetype = "dashed")) + ylab("") + xlab("OPS")
```

```{r Figure_3.5}
## Figure 3.5 - I can't seem to do make this figure with ggplot.
stripchart(hof$MidCareer, method = "jitter", pch = 19, xlab = "Mid Career")
```

```{r Figure_3.6}
## Figure 3.6
ggplot(hof, aes(x = MidCareer)) + theme_bw() + geom_histogram(binwidth = 5, fill = "grey", color = "black") + ylab("Frequency") + ylab("Frequency")
```

```{r Figure_3.7}
## Figure 3.7
ggplot(hof, aes(x = MidCareer, y = OPS))+ theme_bw() + geom_point(size = 2) + stat_smooth(method = "loess", col = "black", se = FALSE)
```

```{r Figure_3.8}
## Figure 3.8
ggplot(hof, aes(x = OBP, y = SLG)) + geom_point(size = 2.5) + theme_bw() + xlab("On-Base Percentage") + ylab("Slugging Percentage")
```

```{r Figure_3.9}
## Figure 3.9 (Changing the axes limits)
ggplot(hof, aes(x = OBP, y = SLG)) + geom_point(size = 2.5) + theme_bw() + ylim(0.28, 0.75) + xlim(0.25, 0.50) + xlab("On-Base Percentage") + ylab("Slugging Percentage")
```

```{r Figure_3.10}
## Figure 3.10 (with lines delimiting OPS)
ggplot(hof, aes(x = OBP, y = SLG))+ theme_bw() + geom_point(size = 2.5) + ylim(0.28, 0.75) + xlim(0.25, 0.50) + xlab("On-Base Percentage") + ylab("Slugging Percentage") + stat_function(fun = function(x) 0.7 - x) + stat_function(fun = function(x) 0.8 - x) + stat_function(fun = function(x) 0.9 - x) + stat_function(fun = function(x) 1.0 - x) + annotate("text", x = 0.27, y = c(0.42, 0.52, 0.62, 0.72), label = c("OPS = 0.7", "OPS = 0.8", "OPS = 0.9", "OPS = 1.0"))
```

```{r Figure_3.12}
## Figure 3.12
par(plt = c(0.2, 0.95, 0.145, 0.883))
stripchart(HR.Rate ~ Era, data = hof, pch = 19, ylab = "", method = "jitter", las = 1)
```

```{r figure_3.13}
## Figure 3.13
ggplot(hof, aes(y = HR.Rate, x = Era)) + theme_bw() + geom_boxplot(outlier.size = 2, stat = "boxplot") + coord_flip() + xlab("") + ylab("HR Rate")
```

### This next section requires data from the Lahman database, available here: http://www.seanlahman.com/baseball-archive/statistics/
I have added the relevant files from the Lahman database to the "Data" directory.

```{r Section_3.8}
## Section 3.8
master <- read_csv("data/master.csv", col_names = TRUE)
head(master)
dim(master)

getinfo <- function(firstname, lastname){
	playerline <- subset(master, nameFirst == firstname & nameLast == lastname)
	name.code <- as.character(playerline$playerID)
	birthyear <- playerline$birthYear
	birthmonth <- playerline$birthMonth
	birthday <- playerline$birthDay
	byear <- ifelse(birthmonth <= 6, birthyear, birthyear + 1)
	list(name.code = name.code, byear = byear)
}

ruth.info <- getinfo("Babe", "Ruth")
aaron.info <- getinfo("Hank", "Aaron")
bonds.info <- getinfo("Barry", "Bonds")
arod.info <- getinfo("Alex", "Rodriguez")
ruth.info

# comparing Ruth, Aaron, Bonds, and A-Rod
batting <- read_csv("data/batting.csv", col_names = TRUE)
dim(batting)

# I rewrote this to use dplyr
ruth.data <- batting %>% filter(playerID == ruth.info$name.code) %>% mutate(Age = yearID - ruth.info$byear)

aaron.data <- batting %>% filter(playerID == aaron.info$name.code) %>% mutate(Age = yearID - aaron.info$byear)

bonds.data <- batting %>% filter(playerID == bonds.info$name.code) %>% mutate(Age = yearID - bonds.info$byear)

arod.data <- batting %>% filter(playerID == arod.info$name.code) %>% mutate(Age = yearID - arod.info$byear)

## Figure 3.14
with(ruth.data, plot(Age, cumsum(HR), type = "l", lty = 3, lwd = 2, xlab = "Age", ylab = "Career HR", xlim = c(18, 45), ylim = c(0, 800), las = 1))
with(aaron.data, lines(Age, cumsum(HR), lty = 2, lwd = 2))
with(bonds.data, lines(Age, cumsum(HR), lty = 1, lwd = 2))
with(arod.data, lines(Age, cumsum(HR), lty = 4, lwd = 2))
legend("topleft", legend = c("Ruth", "Aaron", "Bonds", "Arod"), lty = c(3, 2, 1, 4), lwd = 2, bty = "n")
```

```{r Section_3.9}
### Section 3.9 - The 1998 home run race
# Look at how f-ing fast readr is!!!
data1998 <- read_csv("https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/all1998.csv", col_names = FALSE)

fields <- read.csv("https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/fields.csv", header = TRUE)
names(data1998) <- fields[, "Header"]

# need to parse out player IDs
retro.ids <- read.csv("https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/retrosheetIDs.csv", header = TRUE)
head(retro.ids)

retro.ids %>% filter(FIRST == "Sammy" & LAST == "Sosa") %>% select(ID)
  
retro.ids %>% filter(FIRST == "Mark" & LAST == "McGwire") %>% select(ID)

sosa.data <- data1998 %>% filter(BAT_ID == "sosas001")
mac.data <- data1998 %>% filter(BAT_ID == "mcgwm001")
dim(sosa.data); dim(mac.data)

# write function to extract variables
createdata <- function(d){
	d$Date <- as.Date(substr(d$GAME_ID, 4, 11), format = "%Y%m%d")
	d <- d[order(d$Date), ]
	d$HR <- ifelse(d$EVENT_CD == 23, 1, 0)
	d$cumHR <- cumsum(d$HR)
	d[, c("Date", "cumHR")]
}

sosa.hr <- createdata(sosa.data)
mac.hr <- createdata(mac.data)
head(sosa.hr); head(mac.hr)

## Figure 3.15
plot(mac.hr, type = "l", lwd = 2, ylab = "HR in 1998", las = 1)
lines(sosa.hr, lwd = 2, col = "grey")
abline(h = 62, lty = 3, lwd = 2)
text(10405, 65, "62")
legend("topleft", legend = c("McGwire (70)", "Sosa (66)"), lwd = 2, col = c("black", "grey"), bty = "n")
```

### Chapter 3 exercises
1. Question 1 - Using the HoF pitching data set:
```{r import_Q_data}
hofpitching <- read_csv("https://raw.githubusercontent.com/maxtoki/baseball_R/master/data/hofpitching.csv", col_names = TRUE)

hofpitching <- hofpitching %>% mutate(BF.group = cut(BF, c(0, 10000, 15000, 20000, 30000), labels = c("Less than 10000", "(10000, 15000)", "(15000, 20000)", "more than 20000"))) %>% rename(Name = X2)

head(hofpitching)
hofpitching[, 2] <- gsub(" HOF", "", hofpitching$Name)
head(hofpitching)
```

  + Construct a frequency table of BF.group using the table function.

```{r Ch3.Q1a}
table(hofpitching$BF.group)
```
  
  + Construct a bar graph of the output from table. How many HOF pitchers faced more than 20,000 *pitchers* in their career?

```{r Ch3.Q1b}
# I think there was a typo in the above question. I propose that BF means "Batters Faced" and that we should replace "pitchers" with "batters." 
# 14 pitchers faced over 20,000 batters
ggplot(hofpitching, aes(BF.group)) + theme_bw() + geom_bar() + ylab("# HoF pitchers") + xlab("# batters faced")
```

  + Construct a pie graph of the BF.group variable. Compare the effec-tiveness of the bar graph and pie graph in comparing the frequencies in the four intervals.

```{r Ch3.Q1c}
pie(table(hofpitching$BF.group), col = c("dark grey", "white", "light grey", "black"))
```

2. Question 2 - HoF pitching continued - WAR
  + Using the hist function, construct a histogram of WAR for the pitchers in the Hall of Fame dataset.

```{r Ch3.Q2a}
ggplot(hofpitching, aes(WAR)) + theme_bw() + geom_histogram(bins = 15) + ylab("Count")
```

  + There are two pitchers who stand out among all of the Hall of Famers on the total WAR variable. Identify these two pitchers.

```{r Ch3.Q2b}
hofpitching %>% arrange(desc(WAR)) %>% slice(1:2) 
# The two pitchers are Cy Young and Walter Johnson
```